<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <script src="assets/vendor/Jquery/jquery-3.6.0.min.js"></script>
    <script src="assets/js/init.js"></script>
    <script>
        verificaLogado().then((isLoggedIn) => {
            if(!isLoggedIn) {
                logout()
            }
        }).catch((error) => {
            console.error(error);
        });

        $.ajax({
            url: `${url}/isadmin`,
            method: "GET",
            headers: {
                "Authorization": `Bearer ${getCookie('tk')}`
            },
            success: res => {
                if (!res.isAdmin) {
                    location.assign('index.html')
                }
            }
        })

    </script>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Paradise Roleplay</title>
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,100,300,500,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="assets/vendor/Bootstrap5/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/main.css" >
</head>
<body class="bg-dark">
<nav id="navBar" class="navbar navbar-expand-lg navbar-dark bg-dark"></nav>
<div class="container mt-3">
    <div class="row my-auto bg-light rounded shadow-sm">
        <div id="datatables-base" class="col-12 col-sm-12 col-md-12 col-lg-12 col-xl-12 mb-3 mt-3">
            <div class="table-responsive">
                <div id="loading" class="text-center">
                    <i class="fas fa-spinner fa-spin"></i> Carregando registros...
                </div>
            </div>
        </div>
    </div>
</div>
<footer class="footer py-3 bg-dark text-white"></footer>
</body>
<script src="assets/js/core.min.js"></script>
<script src="assets/vendor/sweetalret/sweetalert.min.js"></script>
<script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
<script src="assets/vendor/Bootstrap5/js/bootstrap.js"></script>
<script src="https://cdn.datatables.net/1.11.3/js/dataTables.bootstrap5.min.js"></script>
<script src="assets/vendor/Bootstrap5/js/bootstrap.bundle.min.js"></script>
<script src="https://kit.fontawesome.com/08478c52c1.js" crossorigin="anonymous"></script>
<script src="assets/js/main.js" type="module"></script>
<script type="text/javascript">

    $.ajax({
        url: `${url}/users`,
        method: "GET",
        headers: {
            "Authorization": `Bearer ${getCookie('tk')}`
        },
        success: userList => {
            const userMap = {};
            userList.contas.forEach(user => {
                userMap[user.id] = user.name;
            });
            $.ajax({
                url: `${url}/aplicacoes`,
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${getCookie('tk')}`
                },
                beforeSend: () => {
                    $('#loading').show();
                },
                success: res => {
                    $('#loading').hide();
                    switch (res.status) {
                        case 200:
                            const data = res.aplicacoes;
                            const language = {
                                "sEmptyTable": "Nenhum registro encontrado",
                                "sInfo": "Mostrando de _START_ até _END_ de _TOTAL_ registros",
                                "sInfoEmpty": "Mostrando 0 até 0 de 0 registros",
                                "sInfoFiltered": "(Filtrados de _MAX_ registros)",
                                "sInfoPostFix": "",
                                "sInfoThousands": ".",
                                "sLengthMenu": "_MENU_ Resultados por página",
                                "sLoadingRecords": "Carregando...",
                                "sProcessing": "Processando...",
                                "sZeroRecords": "Nenhum registro encontrado",
                                "sSearch": "Pesquisar",
                                "oPaginate": {
                                    "sNext": "Próximo",
                                    "sPrevious": "Anterior",
                                    "sFirst": "Primeiro",
                                    "sLast": "Último"
                                },
                                "oAria": {
                                    "sSortAscending": ": Ordenar colunas de forma ascendente",
                                    "sSortDescending": ": Ordenar colunas de forma descendente"
                                },
                                "select": {
                                    "rows": {
                                        "_": "Selecionado %d linhas",
                                        "0": "Nenhuma linha selecionada",
                                        "1": "Selecionado 1 linha"
                                    }
                                },
                                "buttons": {
                                    "copy": "Copiar para a área de transferência",
                                    "copyTitle": "Cópia bem sucedida",
                                    "copySuccess": {
                                        "1": "Uma linha copiada com sucesso",
                                        "_": "%d linhas copiadas com sucesso"
                                    }
                                }
                            };
                            const table = $('<table id="tabela" class="table table-striped table-bordered"></table>').appendTo('.table-responsive');

                            table.DataTable({
                                data: data,
                                columns: [
                                    {
                                        data: 'user_id',
                                        title: 'Usuário',
                                        render: function (data) {
                                            return userMap[data] || 'Usuário Desconhecido';

                                        }
                                    },
                                    { data: 'nome', title: 'Nome' },
                                    { data: 'sobrenome', title: 'Sobrenome' },
                                    {
                                        data: 'sexo',
                                        title: 'Sexo',
                                        render: function (data) {
                                            return data === 1 ? 'Masculino' : 'Feminino';
                                        }
                                    },
                                    {
                                        data: 'historia',
                                        title: 'História',
                                        render: function (data) {
                                            const trimmedMessage = data.split(' ').slice(0, 8).join(' ');
                                            return trimmedMessage + (data.length > trimmedMessage.length ? '...' : '');
                                        }
                                    },
                                    {
                                        data: 'mensagem',
                                        title: 'Mensagem',
                                        render: function (data) {
                                            const trimmedMessage = data.split(' ').slice(0, 8).join(' ');
                                            return trimmedMessage + (data.length > trimmedMessage.length ? '...' : '');
                                        }
                                    },
                                    {
                                        data: 'status',
                                        title: 'Opções',
                                        render: function () {
                                            return '<div class="text-center"><a class="btn btn-primary"><i class="fas fa-search"></i></a></div>';
                                        }
                                    }
                                ],
                                language: language
                            });
                            table.on('click', '.btn-primary', function () {
                                const table = $('#tabela').DataTable();
                                const rowData = table.row($(this).parents('tr')).data();
                                const appId = rowData.id;

                                const avaliacaoApp = data.filter(filtro => filtro.id === appId)
                                localStorage.setItem('avaliacaoApp', JSON.stringify(avaliacaoApp[0]))

                                window.location.href = 'personagem-avaliar.html';
                            });
                            break;
                        case 404:
                            alert(res.msg)
                            logout()
                            break;
                        default:
                            $('#datatables-base').html(res.msg);
                            break;
                    }
                },
                error: err => {
                    $('#loading').hide();
                    $('#datatables-base').html('<p>Erro na requisição.</p>');
                    console.log(err)
                }
            });
        }
    })

</script>
<script src="assets/js/clean.js" type="text/javascript"></script>
</html>