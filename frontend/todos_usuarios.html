<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <script src="assets/vendor/Jquery/jquery-3.6.0.min.js"></script>
    <script src="assets/js/init.js"></script>
    <script>
        verificaLogado().then((isLoggedIn) => {
            if(!isLoggedIn) {
                logout()
            }
        }).catch((error) => {
            console.error(error);
        });
        $.ajax({
            url: `${url}/isadmin`,
            method: "GET",
            headers: {
                "Authorization": `Bearer ${getCookie('tk')}`
            },
            success: res => {
                if (!res.isAdmin) {
                    location.assign('index.html')
                }
            }
        })

    </script>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Paradise Roleplay</title>
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,100,300,500,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="assets/vendor/Bootstrap5/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/main.css" >
</head>
<body class="bg-dark">
<nav id="navBar" class="navbar navbar-expand-lg navbar-dark bg-dark"></nav>
<div class="container mt-3">
    <div class="row my-auto bg-light rounded shadow-sm">
        <div id="datatables-base" class="col-12 col-sm-12 col-md-12 col-lg-12 col-xl-12 mb-3 mt-3">
            <div class="table-responsive">
                <div id="loading" class="text-center">
                    <i class="fas fa-spinner fa-spin"></i> Carregando registros...
                </div>
            </div>
        </div>
    </div>
</div>
<footer class="footer py-3 bg-dark text-white"></footer>
</body>
<script src="assets/js/core.min.js"></script>
<script src="assets/vendor/sweetalret/sweetalert.min.js"></script>
<script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
<script src="assets/vendor/Bootstrap5/js/bootstrap.js"></script>
<script src="https://cdn.datatables.net/1.11.3/js/dataTables.bootstrap5.min.js"></script>
<script src="assets/vendor/Bootstrap5/js/bootstrap.bundle.min.js"></script>
<script src="https://kit.fontawesome.com/08478c52c1.js" crossorigin="anonymous"></script>
<script src="assets/js/main.js" type="module"></script>
<script>
    $.ajax({
        url: `${url}/users`,
        method: "GET",
        headers: {
            "Authorization": `Bearer ${getCookie('tk')}`
        },
        beforeSend: () => {
            $('#loading').show();
        },
        success: res => {
            $('#loading').hide();

            switch (res.status) {
                case 200:
                    const data = res.contas;
                    const language = {
                        "sEmptyTable": "Nenhum registro encontrado",
                        "sInfo": "Mostrando de _START_ até _END_ de _TOTAL_ registros",
                        "sInfoEmpty": "Mostrando 0 até 0 de 0 registros",
                        "sInfoFiltered": "(Filtrados de _MAX_ registros)",
                        "sInfoPostFix": "",
                        "sInfoThousands": ".",
                        "sLengthMenu": "_MENU_ Resultados por página",
                        "sLoadingRecords": "Carregando...",
                        "sProcessing": "Processando...",
                        "sZeroRecords": "Nenhum registro encontrado",
                        "sSearch": "Pesquisar",
                        "oPaginate": {
                            "sNext": "Próximo",
                            "sPrevious": "Anterior",
                            "sFirst": "Primeiro",
                            "sLast": "Último"
                        },
                        "oAria": {
                            "sSortAscending": ": Ordenar colunas de forma ascendente",
                            "sSortDescending": ": Ordenar colunas de forma descendente"
                        },
                        "select": {
                            "rows": {
                                "_": "Selecionado %d linhas",
                                "0": "Nenhuma linha selecionada",
                                "1": "Selecionado 1 linha"
                            }
                        },
                        "buttons": {
                            "copy": "Copiar para a área de transferência",
                            "copyTitle": "Cópia bem sucedida",
                            "copySuccess": {
                                "1": "Uma linha copiada com sucesso",
                                "_": "%d linhas copiadas com sucesso"
                            }
                        }
                    };
                    const table = $('<table id="tabela" class="table table-striped table-bordered"></table>').appendTo('.table-responsive');

                    table.DataTable({
                        data: data,
                        columns: [
                            { data: 'name', title: 'Usuário' },
                            { 
                                data: 'email', 
                                title: 'E-mail',
                                render: function (data) {
                                    return data == 'Undefined' ? 'Sem email' : data
                                }
                            },
                            {
                                data: 'ip', 
                                title: 'IP',
                                render: function (data) {
                                    if (data === 'N/A' || data === '') {
                                        return ''
                                    } else {
                                        return data
                                    }
                                }
                            },
                            {
                                data: 'vip',
                                title: 'VIP',
                                render: function (data) {
                                    switch (data) {
                                        case 0:
                                            return 'Sem Vip';
                                        case 1:
                                            return 'Basic';
                                        case 2:
                                            return 'Vip Plus';
                                        case 3:
                                            return 'Vip Ultra';
                                    }
                                }
                            },
                            {
                                data: 'viptime',
                                title: 'Tempo de VIP',
                                render: function (data) {
                                    if (data === 0) {
                                        return '0 dias'
                                    }
                                    if (data >= 365) {
                                        const ano = data/365
                                        return `${parseInt(String(ano))} anos`
                                    }
                                }
                            },
                            {
                                data: 'admin',
                                title: 'Admin',
                                render: function (data) {
                                    return data === 1 ? "Sim" : "Não"
                                }
                            },
                            {
                                data: 'id',
                                title: 'Editar',
                                render: function () {
                                    return '<div class="text-center"><a class="btn btn-primary">Editar</a></div>';
                                }
                            }
                        ],
                        language: language
                    });
                    table.on('click', '.btn-primary', function () {
                        const table = $('#tabela').DataTable();
                        const rowData = table.row($(this).parents('tr')).data();
                        const idClicado = rowData.id;
                        const userApp = data.filter(filtro => filtro.id === idClicado)[0]

                        const vipLevelTexts = ['Sem VIP', 'VIP Basic', 'VIP Plus', 'VIP Ultra'];
                        const vipLevelValue = userApp.vip; // Assuming vip is a numeric value (0 to 3)

                        const emailValue = userApp.email === 'Undefined' ? '' : userApp.email; // Replace undefined with an empty string

                        swal({
                            title: 'Editar Usuário',
                            content: {
                                element: 'div',
                                attributes: {
                                    className: '',
                                    innerHTML: `
                                <div class="mb-3">
                                    <label for="name" class="form-label">Nome</label>
                                    <input type="text" id="name" class="form-control" value="${userApp.name}">
                                </div>
                                <div class="mb-3">
                                    <label for="email" class="form-label">E-mail</label>
                                    <input type="email" id="email" class="form-control" value="${emailValue}">
                                    <div class="invalid-feedback" id="emailError"></div>
                                </div>
                                <div class="mb-3">
                                    <label for="password" class="form-label">Senha</label>
                                    <input type="password" id="password" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label for="vip" class="form-label">VIP</label>
                                    <select id="vip" class="form-select">
                                        ${vipLevelTexts.map((text, index) => `
                                            <option value="${index}" ${vipLevelValue === index ? 'selected' : ''}>${text}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="vipDuration" class="form-label">Tempo de VIP</label>
                                    <input min="0" max="3650" type="number" id="vipDuration" class="form-control" value="${userApp.viptime}">
                                </div>
                                <div class="mb-3 form-check">
                                    <input type="checkbox" id="admin" class="form-check-input" ${userApp.admin ? 'checked' : ''}>
                                    <label for="admin" class="form-check-label">Admin</label>
                                </div>
                            `
                                }
                            },
                            buttons: {
                                confirm: {
                                    text: 'Salvar',
                                    value: true,
                                    visible: true,
                                    className: "btn btn-primary",
                                    closeModal: true
                                }
                            },
                            focusConfirm: false,
                        }).then((confirm) => {
                            if (confirm) {
                                const name = document.getElementById('name').value;
                                const email = document.getElementById('email').value;
                                const password = document.getElementById('password').value;
                                const vip = parseInt(document.getElementById('vip').value); // Convert to integer
                                const vipDuration = parseInt(document.getElementById('vipDuration').value);
                                const admin = document.getElementById('admin').checked;

                                // Email validation
                                if (email && !validateEmail(email)) {
                                    swal({
                                        title: 'Erro de Validação',
                                        text: 'Por favor, insira um e-mail válido.',
                                        icon: 'error',
                                        button: 'OK'
                                    });
                                    return;
                                }

                                // Username length validation
                                if (name.length < 3) {
                                    swal({
                                        title: 'Erro de Validação',
                                        text: 'O nome de usuário deve ter pelo menos 3 letras.',
                                        icon: 'error',
                                        button: 'OK'
                                    });
                                    return;
                                }

                                // Update user data here using AJAX request or other methods
                            }
                        })
                        function validateEmail(email) {
                            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                            return regex.test(email);
                        }

                    });
                    break;
                case 404:
                    alert(res.msg)
                    logout()
                    break;
                default:
                    $('#datatables-base').html(res.msg);
                    break;
            }
        },
        error: err => {
            $('#loading').hide();
            $('#datatables-base').html('<p>Erro na requisição.</p>');
            console.log(err)
        }
    });
</script>
<script src="assets/js/clean.js" type="text/javascript"></script>
</html>